(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=e(n);fetch(n.href,o)}})();const N=10,K=30,U=5,mt=10;let u=mt;const E=24;let T=0,ht=0;const k=480,Z=480,P=300,L=140,xt=25,pt=5,Q=180,yt=8,bt=4,wt=.08,et=.35;let tt=0;const Ct=15,Mt=12,I=10,F=3,St=8,D=1;let b=[],st=0,q=0,nt=0,it=0,ot=0,Y=0,V=0,X=0,R=0,W=0,z=0;function at(){T=u*E,ht=u*u-3,tt=u*u}function vt(B){const t=[];let e=St;for(let s=0;s<B;s++)t.push(e),e=Math.max(2,Math.round(2*e/3));return t}function Tt(){b=vt(D),st=b.length>0?I*b[0]:0,q=0;for(let t=1;t<b.length;t++)q+=b[t-1]*b[t];nt=b.reduce((t,e)=>t+e,0),it=(b.length>0?b[b.length-1]:I)*F,ot=F,Y=0,V=Y+st,X=V+q,R=X+nt,W=R+it,z=W+ot}at();Tt();function Bt(B){const t=Math.min(K,Math.max(N,B)),e=N+Math.round((t-N)/U)*U,s=Math.min(K,Math.max(N,e));return s!==u&&(u=s,at()),u}const rt=8,J=["Block Ahead","Block Left","Block Right","Tail Ahead","Tail Left","Tail Right","Food Ahead","Food Side","Dir X","Dir Y"],j=["Straight","Turn left","Turn right"],$=[{x:0,y:-1},{x:1,y:0},{x:0,y:1},{x:-1,y:0}];class It{net;netCtx;board;ctx;chart;chartCtx;stats;showMiniBoardsInLeft=!1;netMouse=null;constructor(t){this.net=t.netCanvas,this.board=t.boardCanvas,this.chart=t.chartCanvas,this.stats=t.statsElement,this.netCtx=this.net.getContext("2d"),this.ctx=this.board.getContext("2d"),this.chartCtx=this.chart.getContext("2d"),this.net.width=k,this.net.height=Z,this.board.width=T,this.board.height=T,this.chart.width=P,this.chart.height=L,this.net.addEventListener("mousemove",e=>{const s=this.net.getBoundingClientRect(),n=this.net.width/s.width,o=this.net.height/s.height;this.netMouse={x:(e.clientX-s.left)*n,y:(e.clientY-s.top)*o}}),this.net.addEventListener("mouseleave",()=>{this.netMouse=null,this.net.style.cursor="default"})}setShowMiniBoardsInLeft(t){this.showMiniBoardsInLeft=t,t&&(this.net.style.cursor="default")}render(t){this.syncBoardSize(),this.showMiniBoardsInLeft&&t.boardAgents.length>0?this.drawBoardGridInNet(t.boardAgents):this.drawNetwork(t),this.drawSingleBoard(t.boardAgent),this.drawHistory(t.fitnessHistory),this.updateStats(t)}syncBoardSize(){(this.board.width!==T||this.board.height!==T)&&(this.board.width=T,this.board.height=T)}segmentDistanceSquared(t,e,s,n,o,r){const h=o-s,g=r-n,c=t-s,d=e-n,w=h*h+g*g;if(w<=1e-6){const i=t-s,a=e-n;return i*i+a*a}let y=(c*h+d*g)/w;y=Math.max(0,Math.min(1,y));const f=s+y*h,C=n+y*g,M=t-f,m=e-C;return M*M+m*m}drawNetwork(t){const{genome:e,activations:s}=t.network;if(this.netCtx.fillStyle="#000",this.netCtx.fillRect(0,0,k,Z),!e||!s)return;let n=.001;for(let i=0;i<F;i++)n=Math.max(n,Math.abs(s.output[i]));const o=b.length,r=24,h=Z-24,g=84,c=k-84,d=[],w=[],y=[],f=[];for(let i=0;i<I;i++)d.push(r+i*(h-r)/Math.max(1,I-1));for(let i=0;i<o;i++)w.push(g+(i+1)*(c-g)/(o+1));for(let i=0;i<o;i++){const a=b[i],l=[];for(let x=0;x<a;x++)l.push(r+x*(h-r)/Math.max(1,a-1));y.push(l)}for(let i=0;i<F;i++)f.push(r+i*(h-r)/Math.max(1,F-1));const C=[];if(o>0){const i=w[0],a=y[0],l=b[0];for(let p=0;p<l;p++){const _=Y+p*I;for(let v=0;v<I;v++)C.push({x1:g,y1:d[v],x2:i,y2:a[p],weight:e[_+v],label:`${J[v]} -> H1:${p+1}`})}let x=V;for(let p=1;p<o;p++){const _=b[p-1],v=b[p],ct=w[p-1],dt=w[p],ft=y[p-1],ut=y[p];for(let G=0;G<v;G++){const gt=x+G*_;for(let H=0;H<_;H++)C.push({x1:ct,y1:ft[H],x2:dt,y2:ut[G],weight:e[gt+H],label:`H${p}:${H+1} -> H${p+1}:${G+1}`})}x+=_*v}const S=w[o-1],A=y[o-1],O=b[o-1];for(let p=0;p<F;p++){const _=R+p*O;for(let v=0;v<O;v++)C.push({x1:S,y1:A[v],x2:c,y2:f[p],weight:e[_+v],label:`H${o}:${v+1} -> ${j[p]}`})}}else for(let i=0;i<F;i++){const a=R+i*I;for(let l=0;l<I;l++)C.push({x1:g,y1:d[l],x2:c,y2:f[i],weight:e[a+l],label:`${J[l]} -> ${j[i]}`})}let M=.001;for(const i of C)M=Math.max(M,Math.abs(i.weight));let m=null;if(this.netMouse){let i=rt*rt;for(const a of C){const l=this.segmentDistanceSquared(this.netMouse.x,this.netMouse.y,a.x1,a.y1,a.x2,a.y2);l<=i&&(i=l,m=a)}}this.net.style.cursor=m?"pointer":"default";for(const i of C){const a=Math.min(1,Math.abs(i.weight)/M);this.netCtx.strokeStyle=i.weight>=0?`rgba(76, 175, 80, ${.15+a*.7})`:`rgba(244, 67, 54, ${.15+a*.7})`,this.netCtx.lineWidth=.5+a*2,this.netCtx.beginPath(),this.netCtx.moveTo(i.x1,i.y1),this.netCtx.lineTo(i.x2,i.y2),this.netCtx.stroke()}m&&(this.netCtx.strokeStyle="rgba(255, 255, 255, 0.95)",this.netCtx.lineWidth=3,this.netCtx.beginPath(),this.netCtx.moveTo(m.x1,m.y1),this.netCtx.lineTo(m.x2,m.y2),this.netCtx.stroke()),this.netCtx.fillStyle="rgba(255, 255, 255, 0.9)",this.netCtx.font="12px JetBrains Mono, monospace",this.netCtx.fillText("Input",g-28,14);for(let i=0;i<o;i++)this.netCtx.fillText(`H${i+1}`,w[i]-10,14);o===0&&this.netCtx.fillText("Direct",k/2-20,14),this.netCtx.fillText("Output",c-24,14);for(let i=0;i<I;i++){const a=s.input[i],l=Math.min(1,Math.abs(a));l>.02&&(this.netCtx.fillStyle=a>=0?`rgba(41, 182, 246, ${.1+l*.55})`:`rgba(255, 183, 77, ${.1+l*.55})`,this.netCtx.beginPath(),this.netCtx.arc(g,d[i],7+l*4,0,Math.PI*2),this.netCtx.fill()),this.netCtx.fillStyle=a>=0?"#29b6f6":"#ffb74d",this.netCtx.beginPath(),this.netCtx.arc(g,d[i],5,0,Math.PI*2),this.netCtx.fill(),this.netCtx.fillStyle="rgba(255, 255, 255, 0.88)",this.netCtx.font="10px JetBrains Mono, monospace",this.netCtx.fillText(J[i],6,d[i]+3)}for(let i=0;i<o;i++){const a=s.hidden[i],l=y[i];for(let x=0;x<l.length;x++){const S=a[x],A=Math.min(1,Math.abs(S));A>.02&&(this.netCtx.fillStyle=S>=0?`rgba(76, 175, 80, ${.1+A*.6})`:`rgba(244, 67, 54, ${.1+A*.6})`,this.netCtx.beginPath(),this.netCtx.arc(w[i],l[x],7+A*4,0,Math.PI*2),this.netCtx.fill()),this.netCtx.fillStyle=S>=0?"#26a69a":"#ef5350",this.netCtx.beginPath(),this.netCtx.arc(w[i],l[x],5,0,Math.PI*2),this.netCtx.fill()}}for(let i=0;i<F;i++){const a=s.output[i],l=Math.min(1,Math.abs(a)/n);l>.02&&(this.netCtx.fillStyle=a>=0?`rgba(76, 175, 80, ${.12+l*.6})`:`rgba(244, 67, 54, ${.12+l*.6})`,this.netCtx.beginPath(),this.netCtx.arc(c,f[i],8+l*5,0,Math.PI*2),this.netCtx.fill()),this.netCtx.fillStyle=i===s.best?"#ffd54f":"#ffb74d",this.netCtx.beginPath(),this.netCtx.arc(c,f[i],6,0,Math.PI*2),this.netCtx.fill(),i===s.best&&(this.netCtx.strokeStyle="rgba(255, 255, 255, 0.9)",this.netCtx.lineWidth=1.5,this.netCtx.beginPath(),this.netCtx.arc(c,f[i],9,0,Math.PI*2),this.netCtx.stroke()),this.netCtx.fillStyle="rgba(255, 255, 255, 0.9)",this.netCtx.font="11px JetBrains Mono, monospace",this.netCtx.fillText(j[i],c+12,f[i]+3),this.netCtx.fillStyle="rgba(255, 255, 255, 0.65)",this.netCtx.font="9px JetBrains Mono, monospace",this.netCtx.fillText(`b=${e[W+i].toFixed(2)}`,c+12,f[i]+14),this.netCtx.fillText(`a=${a.toFixed(2)}`,c+12,f[i]+24)}if(m&&this.netMouse){const i=m.label,a=`w = ${m.weight.toFixed(4)}`;this.netCtx.font="10px JetBrains Mono, monospace";const x=Math.max(this.netCtx.measureText(i).width,this.netCtx.measureText(a).width)+12,S=34,A=Math.min(k-x-4,this.netMouse.x+10),O=Math.max(4,this.netMouse.y-S-8);this.netCtx.fillStyle="rgba(12, 12, 12, 0.95)",this.netCtx.fillRect(A,O,x,S),this.netCtx.strokeStyle="rgba(255, 255, 255, 0.25)",this.netCtx.lineWidth=1,this.netCtx.strokeRect(A,O,x,S),this.netCtx.fillStyle="rgba(255, 255, 255, 0.92)",this.netCtx.fillText(i,A+6,O+13),this.netCtx.fillStyle="rgba(255, 255, 255, 0.75)",this.netCtx.fillText(a,A+6,O+26)}}drawSingleBoard(t){this.drawBoardAt(this.ctx,t,0,0,T)}drawBoardGridInNet(t){this.drawBoardGrid(this.netCtx,this.net.width,this.net.height,t),this.net.style.cursor="default"}drawBoardGrid(t,e,s,n){t.fillStyle="#000",t.fillRect(0,0,e,s);const o=Math.max(1,pt),r=Math.max(1,Math.ceil(n.length/o)),h=Math.max(2,Math.floor(Math.min(e,s)*.01)),g=(e-h*(o+1))/o,c=(s-h*(r+1))/r,d=Math.max(8,Math.floor(Math.min(g,c))),w=d*o+h*(o-1),y=d*r+h*(r-1),f=Math.floor((e-w)/2),C=Math.floor((s-y)/2);for(let M=0;M<n.length;M++){const m=Math.floor(M/o),i=M%o,a=f+i*(d+h),l=C+m*(d+h),x=n[M];t.strokeStyle=x.alive?"rgba(100, 108, 255, 0.45)":"rgba(244, 67, 54, 0.45)",t.lineWidth=1,t.strokeRect(a-1.5,l-1.5,d+3,d+3),this.drawBoardAt(t,x,a,l,d),x.alive||(t.fillStyle="rgba(0, 0, 0, 0.45)",t.fillRect(a,l,d,d))}}drawBoardAt(t,e,s,n,o){const r=o/T;t.save(),t.translate(s,n),t.scale(r,r),t.fillStyle="#000",t.fillRect(0,0,T,T),t.strokeStyle="rgba(255, 255, 255, 0.12)",t.lineWidth=1.1;for(let h=0;h<=T;h+=E)t.beginPath(),t.moveTo(h+.5,0),t.lineTo(h+.5,T),t.stroke(),t.beginPath(),t.moveTo(0,h+.5),t.lineTo(T,h+.5),t.stroke();t.fillStyle="#f44336",t.fillRect(e.food.x*E+3,e.food.y*E+3,E-6,E-6);for(let h=e.body.length-1;h>=0;h--){const g=e.body[h];t.fillStyle=h===0?"#4caf50":"#43a047",t.fillRect(g.x*E+2,g.y*E+2,E-4,E-4)}t.restore()}drawHistory(t){this.chartCtx.fillStyle="#000",this.chartCtx.fillRect(0,0,P,L),this.chartCtx.strokeStyle="rgba(255, 255, 255, 0.12)",this.chartCtx.lineWidth=1;for(let s=1;s<=3;s++){const n=L*s/4;this.chartCtx.beginPath(),this.chartCtx.moveTo(0,n+.5),this.chartCtx.lineTo(P,n+.5),this.chartCtx.stroke()}if(t.length<2)return;let e=1;for(const s of t)s>e&&(e=s);this.chartCtx.strokeStyle="#646cff",this.chartCtx.lineWidth=2,this.chartCtx.beginPath();for(let s=0;s<t.length;s++){const n=10+s/(t.length-1)*(P-20),o=L-10-t[s]/e*(L-20);s===0?this.chartCtx.moveTo(n,o):this.chartCtx.lineTo(n,o)}this.chartCtx.stroke(),this.chartCtx.fillStyle="rgba(255, 255, 255, 0.75)",this.chartCtx.font="12px IBM Plex Mono, monospace",this.chartCtx.fillText(`Gen best fitness history (max ${e.toFixed(2)})`,10,16)}updateStats(t){this.stats.innerHTML=[`Generation: <strong>${t.generation}</strong>`,`Alive: ${t.alive}/${t.populationSize}`,`Grid: ${u}x${u}`,`Best score: ${t.bestEverScore}`,`Best fitness: ${t.bestEverFitness.toFixed(2)}`,`Stale: ${t.staleGenerations}`].join("<br>")}}const At=.4;class Et{randomGenome(){const t=new Float32Array(z);for(let e=0;e<t.length;e++)t[e]=this.randomRange(-1,1);return t}evolve(t){for(const n of t)n.fitness=this.fitness(n);const e=[...t].sort((n,o)=>o.fitness-n.fitness),s=[];for(let n=0;n<yt;n++)s.push(e[n].genome);for(;s.length<Q;){const n=this.pickParent(e),o=this.pickParent(e),r=this.crossover(n.genome,o.genome);this.mutate(r),s.push(r)}return{best:e[0],nextGenomes:s}}randomRange(t,e){return t+Math.random()*(e-t)}randomIndex(t){return Math.floor(Math.random()*t)}fitness(t){const e=t.score,s=!t.alive&&t.hunger>0?1:0,n=t.steps/(u*u);return e-s-n}crossover(t,e){const s=new Float32Array(z);for(let n=0;n<z;n++)s[n]=Math.random()<.5?t[n]:e[n];return s}mutate(t){for(let e=0;e<t.length;e++)Math.random()<wt&&(t[e]+=this.randomRange(-et,et))}pickParent(t){const e=Math.max(2,Math.floor(t.length*At));let s=t[this.randomIndex(e)];for(let n=1;n<bt;n++){const o=t[this.randomIndex(e)];o.fitness>s.fitness&&(s=o)}return s}}function lt(){return b.map(B=>new Float32Array(B))}class Ft{actionHiddenBuffers=lt();chooseAction(t,e){return this.run(t,e,this.actionHiddenBuffers)}run(t,e,s,n){{const c=b[0],d=s[0];for(let f=0;f<c;f++){let C=t[X+f];const M=Y+f*I;for(let m=0;m<I;m++)C+=t[M+m]*e[m];d[f]=Math.tanh(C)}let w=V,y=X+c;for(let f=1;f<D;f++){const C=s[f-1],M=s[f],m=b[f-1],i=b[f];for(let a=0;a<i;a++){let l=t[y+a];const x=w+a*m;for(let S=0;S<m;S++)l+=t[x+S]*C[S];M[a]=Math.tanh(l)}w+=m*i,y+=i}}let o=0,r=Number.NEGATIVE_INFINITY;const h=s[D-1],g=b[D-1];for(let c=0;c<F;c++){let d=t[W+c];const w=R+c*g;for(let y=0;y<g;y++)d+=t[w+y]*h[y];n&&(n[c]=d),d>r&&(r=d,o=c)}return o}}function Ot(){return lt()}class _t{constructor(t){this.network=t}actionInputs=new Float32Array(I);vizInputs=new Float32Array(I);vizHidden=Ot();vizOutputs=new Float32Array(F);createAgent(t){const e=Math.floor(u/2),s=Math.floor(u/2),n=[{x:e,y:s},{x:e-1,y:s},{x:e-2,y:s}];return{genome:new Float32Array(t),body:n,dir:1,food:this.randomFood(n),alive:!0,score:0,steps:0,hunger:tt,fitness:0}}step(t){if(!t.alive)return;switch(this.chooseAction(t)){case 1:t.dir=(t.dir+3)%4;break;case 2:t.dir=(t.dir+1)%4;break}const s=$[t.dir],n=t.body[0],o={x:n.x+s.x,y:n.y+s.y};if(t.steps+=1,t.hunger-=1,this.outOfBounds(o.x,o.y)){t.alive=!1;return}const r=o.x===t.food.x&&o.y===t.food.y,h=r?t.body.length:t.body.length-1;if(this.pointInBody(t.body,o,h)){t.alive=!1;return}if(t.body.unshift(o),r){if(t.score+=1,t.score>=ht){t.alive=!1;return}t.hunger=tt,t.food=this.randomFood(t.body)}else t.body.pop();t.hunger<=0&&(t.alive=!1)}computeNetworkActivations(t,e){e?this.senseInto(e,this.vizInputs):this.vizInputs.fill(0);const s=this.network.run(t,this.vizInputs,this.vizHidden,this.vizOutputs);return{input:this.vizInputs,hidden:this.vizHidden,output:this.vizOutputs,best:s}}randomIndex(t){return Math.floor(Math.random()*t)}randomFood(t){if(t.length>=u*u)return{...t[0]};for(;;){const e={x:this.randomIndex(u),y:this.randomIndex(u)};if(!this.pointInBody(t,e,t.length))return e}}pointInBody(t,e,s){for(let n=0;n<s;n++){const o=t[n];if(o.x===e.x&&o.y===e.y)return!0}return!1}outOfBounds(t,e){return t<0||t>=u||e<0||e>=u}checkForObstacle(t,e,s){const n=t.x+e.x,o=t.y+e.y;if(this.outOfBounds(n,o))return 1;for(let r=1;r<s.length;r++)if(s[r].x===n&&s[r].y===o)return 1;return 0}findTailDistance(t,e,s){for(let n=1;n<=u;n++){const o=t.x+e.x*n,r=t.y+e.y*n;if(this.outOfBounds(o,r))return 0;for(let h=1;h<s.length;h++)if(s[h].x===o&&s[h].y===r)return 1/n}return 0}checkForFood(t,e,s){const n=s.x-t.x,o=s.y-t.y,r=n*e.x+o*e.y;return Math.sign(r)}senseInto(t,e){const s=t.body[0],n=$[t.dir],o=$[(t.dir+3)%4],r=$[(t.dir+1)%4];e[0]=this.checkForObstacle(s,n,t.body),e[1]=this.checkForObstacle(s,o,t.body),e[2]=this.checkForObstacle(s,r,t.body),e[3]=this.findTailDistance(s,n,t.body),e[4]=this.findTailDistance(s,o,t.body),e[5]=this.findTailDistance(s,r,t.body),e[6]=this.checkForFood(s,n,t.food)>0?1:0,e[7]=this.checkForFood(s,o,t.food),e[8]=n.x,e[9]=n.y}chooseAction(t){return this.senseInto(t,this.actionInputs),this.network.chooseAction(t.genome,this.actionInputs)}}class Gt{ga=new Et;network=new Ft;environment=new _t(this.network);population=[];generation=1;bestEverScore=0;bestEverFitness=0;bestFitnessGen=1;fitnessHistory=[];showcaseGenome=null;showcaseAgent=null;randomBoardAgents=[];randomBoardGeneration=-1;constructor(){this.reset()}reset(){this.population=[],this.generation=1,this.bestEverScore=0,this.bestEverFitness=0,this.bestFitnessGen=1,this.fitnessHistory=[],this.showcaseGenome=null,this.showcaseAgent=null,this.invalidateRandomBoardAgents();for(let t=0;t<Q;t++)this.population.push(this.environment.createAgent(this.ga.randomGenome()));this.population.length>0&&this.setShowcaseGenome(this.population[0].genome)}simulate(t){for(let e=0;e<t;e++){let s=0;for(const n of this.population)n.alive&&(this.environment.step(n),n.alive&&(s+=1));s===0&&this.evolve(),this.showcaseAgent&&this.environment.step(this.showcaseAgent),!this.showcaseAgent?.alive&&this.showcaseGenome&&(this.showcaseAgent=this.environment.createAgent(this.showcaseGenome))}}getState(t=0){let e=0;for(const o of this.population)o.alive&&(e+=1);const s=this.showcaseAgent??this.population[0],n=this.showcaseGenome?{genome:this.showcaseGenome,activations:this.environment.computeNetworkActivations(this.showcaseGenome,this.showcaseAgent)}:{genome:null,activations:null};return{boardAgent:s,boardAgents:this.getRandomBoardAgents(t),fitnessHistory:this.fitnessHistory,generation:this.generation,alive:e,populationSize:Q,bestEverScore:this.bestEverScore,bestEverFitness:this.bestEverFitness,staleGenerations:Math.max(0,this.generation-this.bestFitnessGen),network:n}}onGridSizeChanged(){this.population=this.population.map(t=>this.environment.createAgent(t.genome)),this.showcaseGenome?this.showcaseAgent=this.environment.createAgent(this.showcaseGenome):this.showcaseAgent=null,this.invalidateRandomBoardAgents()}setShowcaseGenome(t){this.showcaseGenome=new Float32Array(t),this.showcaseAgent=this.environment.createAgent(this.showcaseGenome)}invalidateRandomBoardAgents(){this.randomBoardAgents=[],this.randomBoardGeneration=-1}sampleAgents(t,e){const s=Math.min(e,t.length),n=t.slice(),o=[];for(let r=0;r<s;r++){const h=r+Math.floor(Math.random()*(n.length-r));[n[r],n[h]]=[n[h],n[r]],o.push(n[r])}return o}getRandomBoardAgents(t){if(t<=0)return[];const e=Math.min(t,this.population.length),s=this.randomBoardGeneration!==this.generation,n=this.randomBoardAgents.length!==e;if(s||n){const h=this.sampleAgents(this.population.filter(c=>c.alive),e),g=e-h.length;if(g>0){const c=new Set(h),d=this.sampleAgents(this.population.filter(w=>!c.has(w)),g);this.randomBoardAgents=h.concat(d)}else this.randomBoardAgents=h;this.randomBoardGeneration=this.generation}const o=new Set(this.randomBoardAgents.filter(h=>h.alive)),r=this.population.filter(h=>h.alive&&!o.has(h));for(let h=0;h<this.randomBoardAgents.length;h++){if(this.randomBoardAgents[h].alive||r.length===0)continue;const c=Math.floor(Math.random()*r.length),d=r[c];this.randomBoardAgents[h]=d,o.add(d),r[c]=r[r.length-1],r.pop()}return this.randomBoardAgents}evolve(){const{best:t,nextGenomes:e}=this.ga.evolve(this.population);this.bestEverScore=Math.max(this.bestEverScore,t.score),(this.generation===1||t.fitness>this.bestEverFitness)&&(this.bestEverFitness=t.fitness,this.bestFitnessGen=this.generation,this.setShowcaseGenome(t.genome)),this.fitnessHistory.push(t.fitness),this.fitnessHistory.length>500&&this.fitnessHistory.shift(),this.population=e.map(s=>this.environment.createAgent(s)),this.generation+=1,this.invalidateRandomBoardAgents()}}class Ht{trainer=new Gt;renderer;turboToggle;leftViewToggle;gridDownButton;gridUpButton;resetButton;gridValue;turboMode=!1;showMiniBoardsInLeft=!1;stepBudget=0;lastFrameTime=0;constructor(){const t=this.getCanvas("netCanvas"),e=this.getCanvas("gameCanvas"),s=this.getCanvas("chartCanvas"),n=this.getElement("stats");this.turboToggle=this.getInput("turboToggle"),this.leftViewToggle=this.getInput("leftViewToggle"),this.gridDownButton=this.getButton("gridDown"),this.gridUpButton=this.getButton("gridUp"),this.resetButton=this.getButton("resetTraining"),this.gridValue=this.getElement("gridValue"),this.renderer=new It({netCanvas:t,boardCanvas:e,chartCanvas:s,statsElement:n}),this.turboMode=this.turboToggle.checked,this.turboToggle.addEventListener("change",()=>{this.turboMode=this.turboToggle.checked,this.stepBudget=0}),this.showMiniBoardsInLeft=this.leftViewToggle.checked,this.renderer.setShowMiniBoardsInLeft(this.showMiniBoardsInLeft),this.leftViewToggle.addEventListener("change",()=>{this.showMiniBoardsInLeft=this.leftViewToggle.checked,this.renderer.setShowMiniBoardsInLeft(this.showMiniBoardsInLeft)}),this.gridDownButton.addEventListener("click",()=>{this.updateGridSize(-U)}),this.gridUpButton.addEventListener("click",()=>{this.updateGridSize(U)}),this.resetButton.addEventListener("click",()=>{this.resetTraining()}),this.refreshGridControls(),requestAnimationFrame(this.loop)}getCanvas(t){const e=document.getElementById(t);if(!(e instanceof HTMLCanvasElement))throw new Error(`Missing canvas: ${t}`);return e}getElement(t){const e=document.getElementById(t);if(!e)throw new Error(`Missing element: ${t}`);return e}getInput(t){const e=document.getElementById(t);if(!(e instanceof HTMLInputElement))throw new Error(`Missing input: ${t}`);return e}getButton(t){const e=document.getElementById(t);if(!(e instanceof HTMLButtonElement))throw new Error(`Missing button: ${t}`);return e}updateGridSize(t){const e=u,s=Bt(e+t);this.refreshGridControls(),s!==e&&(this.trainer.onGridSizeChanged(),this.stepBudget=0,this.lastFrameTime=0)}refreshGridControls(){this.gridValue.textContent=`${u}x${u}`,this.gridDownButton.disabled=u<=N,this.gridUpButton.disabled=u>=K}resetTraining(){this.trainer.reset(),this.stepBudget=0,this.lastFrameTime=0}loop=t=>{this.lastFrameTime===0&&(this.lastFrameTime=t);const e=Math.max(0,(t-this.lastFrameTime)/1e3);if(this.lastFrameTime=t,this.turboMode){const n=performance.now();do this.trainer.simulate(1);while(performance.now()-n<Mt)}else{this.stepBudget+=e*Ct;const n=Math.floor(this.stepBudget);n>0&&(this.stepBudget-=n,this.trainer.simulate(n))}const s=this.showMiniBoardsInLeft?xt:0;this.renderer.render(this.trainer.getState(s)),requestAnimationFrame(this.loop)}}new Ht;
